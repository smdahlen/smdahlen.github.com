
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Setup node.js Servers Within a Load-balanced Configuration - Shawn Dahlen</title>
  <meta name="author" content="Shawn Dahlen">

  
  <meta name="description" content="A step-by-step guide to setup a Node.js project, provision it with Chef, and deploy it within a load-balanced configuration using HAProxy.">
  <meta name="keywords" content="nodejs,haproxy,vagrant,chef,requirejs,backbone,express,startup">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://smdahlen.github.com/blog/2013/03/18/setup-node-dot-js-servers-within-a-load-balanced-configuration">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Shawn Dahlen" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1951656-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Shawn Dahlen</a></h1>
  
    <h2>Periodic updates on my software startup endeavor</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:smdahlen.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Setup node.js Servers Within a Load-balanced Configuration</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-18T13:21:00-04:00" pubdate data-updated="true">Mar 18<span>th</span>, 2013</time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://smdahlen.github.com">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>With an excellent <a href="http://shawn.dahlen.me/blog/2013/03/06/automate-provisioning-of-secure-servers/">foundation</a> in place to automate provisioning of secure
servers with Chef, I spent week two establishing an application project
structure using the <a href="http://nodejs.org/">Node.js</a> platform. Additionally, I setup a load
balancer configuration with <a href="http://haproxy.1wt.eu/">HAProxy</a> and tested it using a local
multi-machine <a href="http://www.vagrantup.com/">Vagrant</a> environment. Read on to find out details about
this setup.</p>

<!-- more -->


<h2>Value &amp; Exit Criteria</h2>

<p>As I mentioned in my <a href="http://shawn.dahlen.me/blog/2013/03/06/automate-provisioning-of-secure-servers/">previous post</a>, I start each week defining the
business value for the task at hand coupled with concise exit criteria to
know when I&rsquo;m done. This week&rsquo;s task will ensure the conversion rate for
subscribers is not impacted as the product usage grows. I consider the
first impression of the product&rsquo;s experience extremely important and I don&rsquo;t
want to see that disrupted as I try to scale a system in production.</p>

<p>To complete the task, four critera had to be met:</p>

<ul>
<li>Setup a project structure for Node.js supporting a rapid development workflow
and optimized production deployment.</li>
<li>Implement a Chef recipe to provision the Node.js application.</li>
<li>Implement a Chef recipe to provision HAProxy configured to load balance
multiple Node.js application servers.</li>
<li>Test the Chef recipes using a local multi-machine Vagrant environment.</li>
</ul>


<h2>Setup a Node.js Project</h2>

<p>Given my experience with Node.js from my previous job at Lockheed Martin, I
selected it as the platform to build my product. I intend to implement a
thin server architecture supporting a <a href="http://en.wikipedia.org/wiki/Single-page_application">single-page application</a>.
Essentially, all the user interface logic will reside on the client using
JavaScript libraries such as <a href="http://jquery.com/">jQuery</a>, <a href="http://requirejs.org/">require.js</a>, and
<a href="http://documentcloud.github.com/backbone/">Backbone</a>. The user interface will query an API layer built on the
<a href="http://expressjs.com/">Express</a> web application framework for Node.js.</p>

<p>Below is a step-by-step guide to setup a basic Node.js project using these
libraries. It assumes that Node.js and npm are installed.</p>

<ul>
<li><strong>Setup Express.</strong> I began by creating a new directory, <em>marinara</em>, and
initialized it as a git repository. Next, I created the <em>package.json</em> file
which defines metadata for the project including its dependencies. Within that
file I specified the Express version I required and then installed it
using <a href="https://npmjs.org/">npm</a>.</li>
</ul>


<figure class='code'><figcaption><span>package.json </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;marinara&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;version&quot;</span><span class="o">:</span> <span class="s2">&quot;0.1.0&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;engines&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s2">&quot;node&quot;</span><span class="o">:</span> <span class="s2">&quot;0.10.x&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="s2">&quot;dependencies&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s2">&quot;express&quot;</span><span class="o">:</span> <span class="s2">&quot;~3.1.0&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;log&quot;</span><span class="o">:</span> <span class="s2">&quot;~1.3.1&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;underscore&quot;</span><span class="o">:</span> <span class="s2">&quot;~1.4.4&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;consolidate&quot;</span><span class="o">:</span> <span class="s2">&quot;~0.8.0&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="s2">&quot;devDependencies&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ npm install</span></code></pre></td></tr></table></div></figure>


<p>  With Express installed, I created a <em>server.js</em> file at the root of the
  project directory and implemented a basic application with a simple logging
  and configuration strategy. Specifically, I defined configuration through
  environment variables (with suitable defaults) that will later be set with an
  <a href="http://upstart.ubuntu.com/cookbook/">Upstart</a> script. I leveraged the <a href="https://github.com/visionmedia/log.js/">log.js</a> module to write messages
  using the log levels specified by syslog that will later be consolidated with
  an <a href="http://www.rsyslog.com/">rsyslog</a> server.</p>

<figure class='code'><figcaption><span>server.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">Log</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">api</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/api&#39;</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">pkg</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./package.json&#39;</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// defines app settings with default values</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;log level&#39;</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MARINARA_LOG_LEVEL</span> <span class="o">||</span> <span class="nx">Log</span><span class="p">.</span><span class="nx">DEBUG</span><span class="p">);</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;session secret&#39;</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MARINARA_SESSION_SECRET</span> <span class="o">||</span> <span class="s1">&#39;secret&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;session age&#39;</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MARINARA_SESSION_AGE</span> <span class="o">||</span> <span class="mi">3600</span><span class="p">);</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MARINARA_PORT</span> <span class="o">||</span> <span class="mi">8000</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// configures default logger available for middleware and requests</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">req</span><span class="p">.</span><span class="nx">log</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Log</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;log level&#39;</span><span class="p">));</span>
</span><span class='line'>    <span class="nx">next</span><span class="p">();</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// logs all requests if log level is INFO or higher using log module format</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;log level&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nx">Log</span><span class="p">.</span><span class="nx">INFO</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">format</span> <span class="o">=</span> <span class="s1">&#39;[:date] INFO :remote-addr - :method :url &#39;</span> <span class="o">+</span>
</span><span class='line'>                 <span class="s1">&#39;:status :res[content-length] - :response-time ms&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">express</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">token</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span> <span class="p">});</span>
</span><span class='line'>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">logger</span><span class="p">(</span><span class="nx">format</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// TODO: setup cluster support</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><strong>Serve static assets and api requests.</strong> With the basic application
structure complete, I implmented support to serve static assets both in
development and production. During development, static assets are served
from the <em>app/</em> directory using require.js to keep code modular. For
production, assets are optimized (concatnated and minified) and placed in
the <em>public/</em> directory. The single html page, <em>index.html</em>, is an
<a href="http://underscorejs.org/#template">underscore.js micro-template</a> that replaces script and stylesheet
references depending on the mode.</li>
</ul>


<figure class='code'><figcaption><span>server.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// configures underscore view engine</span>
</span><span class='line'><span class="c1">// TODO: set caching for production</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">engine</span><span class="p">(</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;consolidate&#39;</span><span class="p">).</span><span class="nx">underscore</span><span class="p">);</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;view engine&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;views&#39;</span><span class="p">,</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/templates&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// enables compression for all requests</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">compress</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// serves index and static assets from app/ directory in development</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="s1">&#39;development&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">jsFile</span><span class="o">:</span> <span class="s1">&#39;public/components/requirejs/require.js&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">cssFile</span><span class="o">:</span> <span class="s1">&#39;public/styles/main.css&#39;</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/public&#39;</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/app&#39;</span><span class="p">));</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// serves index and static assets from optimized public/ directory in prod</span>
</span><span class='line'><span class="c1">// TODO: replace staticCache middleware with varnish</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="s1">&#39;production&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">oneYear</span> <span class="o">=</span> <span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">baseFile</span> <span class="o">=</span> <span class="s1">&#39;public/&#39;</span> <span class="o">+</span> <span class="nx">pkg</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nx">pkg</span><span class="p">.</span><span class="nx">version</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">jsFile</span><span class="o">:</span> <span class="nx">baseFile</span> <span class="o">+</span> <span class="s1">&#39;.min.js&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">cssFile</span><span class="o">:</span> <span class="nx">baseFile</span> <span class="o">+</span> <span class="s1">&#39;.min.css&#39;</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/public&#39;</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="nx">staticCache</span><span class="p">());</span>
</span><span class='line'>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/public&#39;</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/public&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">maxAge</span><span class="o">:</span> <span class="nx">oneYear</span> <span class="p">}));</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>templates/index.html </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span><span class='line'><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;head&gt;</span>
</span><span class='line'>    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;UTF-8&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;title&gt;</span>Marinara<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>    <span class="nt">&lt;link</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;&lt;%= cssFile %&gt;&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;/head&gt;</span>
</span><span class='line'><span class="nt">&lt;body&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">data-main=</span><span class="s">&quot;public/scripts/main&quot;</span> <span class="na">src=</span><span class="s">&quot;&lt;%= jsFile %&gt;&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>  While I have not flushed out the api for the product yet, I went ahead and
  stubbed out a basic implementation. I created a sub-application in
  <em>lib/api.js</em> where I configured middleware to handle secure cookie sessions,
  cross-site request forgery, and body parsing. This sub-application is
  exported and mounted at the <em>/api</em> path on the main Express application in
  <em>server.js</em>.</p>

<figure class='code'><figcaption><span>lib/api.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">cookieParser</span><span class="p">());</span>
</span><span class='line'>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">cookieSession</span><span class="p">({</span>
</span><span class='line'>        <span class="nx">secret</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">sessionSecret</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">cookie</span><span class="o">:</span> <span class="p">{</span> <span class="nx">maxAge</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">sessionAge</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}));</span>
</span><span class='line'>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">bodyParser</span><span class="p">());</span>
</span><span class='line'>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">csrf</span><span class="p">());</span>
</span><span class='line'>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">router</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/hello&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">req</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;serving /api/hello request&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;Hello Shawn&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nx">app</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>server.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// mounts and configures rest api</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/api&#39;</span><span class="p">,</span> <span class="nx">api</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">sessionSecret</span><span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;session secret&#39;</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">sessionAge</span><span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;session age&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">}));</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><strong>Setup Bower and install client dependencies.</strong> With the server ready to
handle requests, I shifted to the client-side by defining libraries in
<em>component.json</em> that <a href="http://twitter.github.com/bower/">Bower</a>, a browser package manager, would install.
(I will discuss the installation of Bower shortly). I configured Bower
(in the <em>.bowerrc</em> file) to install libraries to <em>app/components</em> so they
could be served by Express during development.</li>
</ul>


<figure class='code'><figcaption><span>component.json </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;marinara&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;version&quot;</span><span class="o">:</span> <span class="s2">&quot;0.1.0&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;dependencies&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s2">&quot;requirejs&quot;</span><span class="o">:</span> <span class="s2">&quot;~2.1.5&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;jquery&quot;</span><span class="o">:</span> <span class="s2">&quot;~1.9.1&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;backbone&quot;</span><span class="o">:</span> <span class="s2">&quot;~0.9.10&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;underscore&quot;</span><span class="o">:</span> <span class="s2">&quot;~1.4.4&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;almond&quot;</span><span class="o">:</span> <span class="s2">&quot;~0.2.5&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>.bowerrc </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;directory&quot;</span><span class="o">:</span> <span class="s2">&quot;app/components&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ bower install</span></code></pre></td></tr></table></div></figure>


<ul>
<li><strong>Setup require.js configuration and main entry point.</strong> As I mentioned
earlier, require.js supports modular development of both css and javascript.
I went ahead and defined a main entry point for require.js, <em>main.js</em>,
which includes configuration to use the libraries installed by Bower. I also
stubbed out a simple Backbone view to test asset optimization later on.</li>
</ul>


<figure class='code'><figcaption><span>app/scripts/main.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">requirejs</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">jquery</span><span class="o">:</span> <span class="s1">&#39;../components/jquery/jquery&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">backbone</span><span class="o">:</span> <span class="s1">&#39;../components/backbone/backbone&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">underscore</span><span class="o">:</span> <span class="s1">&#39;../components/underscore/underscore&#39;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nx">shim</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">backbone</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">deps</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;underscore&#39;</span><span class="p">,</span> <span class="s1">&#39;jquery&#39;</span><span class="p">],</span>
</span><span class='line'>            <span class="nx">exports</span><span class="o">:</span> <span class="s1">&#39;Backbone&#39;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="nx">underscore</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">exports</span><span class="o">:</span> <span class="s1">&#39;_&#39;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">require</span><span class="p">([</span><span class="s1">&#39;jquery&#39;</span><span class="p">,</span> <span class="s1">&#39;marinara&#39;</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">marinara</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">marinara</span><span class="p">.</span><span class="nx">SampleView</span><span class="p">();</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>app/scripts/marinara.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">define</span><span class="p">([</span><span class="s1">&#39;jquery&#39;</span><span class="p">,</span> <span class="s1">&#39;backbone&#39;</span><span class="p">,</span> <span class="s1">&#39;underscore&#39;</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">_</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">exports</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">SampleView</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">SampleView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>        <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;sample&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">template</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="s1">&#39;&lt;h1&gt;&lt;%= msg %&gt;&lt;/h1&gt;&#39;</span><span class="p">),</span>
</span><span class='line'>        <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s1">&#39;click&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;Hello Shawn.&#39;</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">({</span> <span class="nx">msg</span><span class="o">:</span> <span class="s1">&#39;Click me please.&#39;</span> <span class="p">}));</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nx">exports</span><span class="p">;</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><p><strong>Setup Grunt.js build system.</strong> To test changes during development, I setup
an automated watch and reload workflow using <a href="http://gruntjs.com/">Grunt</a>. When files change
in the <em>app/</em> directory, I automatically reload the browser window with the
<a href="http://livereload.com/">LiveReload</a> Chrome extension. When javascript files change in the <em>/</em> or
<em>lib/</em> directories, I restart the Node.js server using Upstart. Additionally,
I also lint both css and javascript files when changes occur. To kickoff this
workflow, I run <em>grunt</em> in the root directory.</p>

<p>I also used Grunt to optimize static assets. The <em>grunt-contrib-requirejs</em>
plugin uses require.js&rsquo;s <a href="http://requirejs.org/docs/optimization.html">optimizer</a> to concatnate and minify javascript.
It also concatnate&rsquo;s css by scanning for <em>@import</em> statements. I paired this
with the <em>grunt-contrib-cssmin</em> plugin to minify css assets. To optimize
assets and move them into the <em>public/</em> directory to be served by Express,
I run:</p></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ grunt optimize</span></code></pre></td></tr></table></div></figure>


<p>  Check out this <a href="https://gist.github.com/smdahlen/5190695">gist</a> for the <em>Gruntfile.js</em> that supports this setup.
  With the build system complete, the first exit criteria was met.</p>

<h2>Implement Chef Application Recipe</h2>

<p>With the Node.js project structure complete, I shifted back to the
<em>marinara-kitchen</em> repository I worked on in the <a href="http://shawn.dahlen.me/blog/2013/03/06/automate-provisioning-of-secure-servers/">last post</a>. I created
a new recipe, <em>application.rb</em>, that would provision Node.js and related
dependencies and deploy the <em>marinara</em> git repository. Below is the
step-by-step guide to create the recipe:</p>

<ul>
<li><strong>Provision Node.js and npm packages.</strong> I leveraged the <a href="https://github.com/mdxp/nodejs-cookbook">nodejs</a> cookbook
to install Node.js and npm by source defining the default versions in the
<em>default.rb</em> attributes file. Additionally, I defined npm packages to be
installed globally on the server (Grunt, Bower) using the LWRP provided
by the <a href="https://github.com/balbeko/chef-npm/">npm</a> cookbook.</li>
</ul>


<figure class='code'><figcaption><span>site-cookbooks/marinara/attributes/default.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># includes nodejs default attributes first to override them</span>
</span><span class='line'><span class="n">include_attribute</span> <span class="s1">&#39;nodejs&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># defines node.js and npm version configuration</span>
</span><span class='line'><span class="n">default</span><span class="o">.</span><span class="n">nodejs</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;0.10.0&#39;</span>
</span><span class='line'><span class="n">default</span><span class="o">.</span><span class="n">nodejs</span><span class="o">.</span><span class="n">npm</span> <span class="o">=</span> <span class="s1">&#39;1.2.14&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># defines npm packages to install globally</span>
</span><span class='line'><span class="n">default</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">npm_packages</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="s1">&#39;grunt-cli&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;0.1.6&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;bower&#39;</span>     <span class="o">=&gt;</span> <span class="s1">&#39;0.8.5&#39;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>site-cookbooks/marinara/recipes/application.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># provisions node.js and npm</span>
</span><span class='line'><span class="n">include_recipe</span> <span class="s1">&#39;nodejs::install_from_source&#39;</span>
</span><span class='line'><span class="n">include_recipe</span> <span class="s1">&#39;nodejs::npm&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># provisions global npm packages</span>
</span><span class='line'><span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">npm_packages</span><span class="o">.</span><span class="n">each_pair</span> <span class="k">do</span> <span class="o">|</span><span class="n">pkg</span><span class="p">,</span> <span class="n">ver</span><span class="o">|</span>
</span><span class='line'>  <span class="n">npm_package</span> <span class="n">pkg</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">version</span> <span class="n">ver</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><strong>Provision Upstart script.</strong> Since I am using Ubuntu, I implemented an
Upstart script to manage the Node.js application as a service. As I mentioned
earlier, I configure the application using environment variables defined in
the Upstart script injected in by a Chef template. The template also
checks whether the application is being provisioned in production mode, and
if so, includes statements to start the service on startup and run under
an application-specific user account.</li>
</ul>


<figure class='code'><figcaption><span>site-cookbooks/marinara/templates/default/marinara.conf.erb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">description</span> <span class="s1">&#39;marinara upstart script&#39;</span>
</span><span class='line'><span class="n">author</span> <span class="s1">&#39;Shawn Dahlen &lt;shawn@dahlen.me&gt;&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="sx">% if </span><span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">development</span> <span class="o">-</span><span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">start on [2345]</span>
</span><span class='line'><span class="sx">setuid &lt;%= node.marinara.application.user %&gt;</span>
</span><span class='line'><span class="n">setgid</span> <span class="o">&lt;</span><span class="sx">%= node.marinara.application.user %&gt;</span>
</span><span class='line'><span class="sx">env NODE_ENV=</span><span class="n">production</span>
</span><span class='line'><span class="o">&lt;</span><span class="sx">% end </span><span class="o">-</span><span class="sx">%&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sx">env MARINARA_LOG_LEVEL=&lt;%= node.marinara.application.log_level %&gt;</span>
</span><span class='line'><span class="n">env</span> <span class="no">MARINARA_PORT</span><span class="o">=&lt;</span><span class="sx">%= node.marinara.application.port %&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sx">stop on [06]</span>
</span><span class='line'>
</span><span class='line'><span class="sx">respawn</span>
</span><span class='line'>
</span><span class='line'><span class="sx">exec /usr/local/bin/node &lt;%=</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">deploy_path</span> <span class="sx">%&gt;/server.js &gt;</span> <span class="o">&lt;%=</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">log_path</span> <span class="sx">%&gt;/marinara.log 2&gt;</span><span class="o">&amp;</span><span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>site-cookbooks/marinara/recipes/application.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># provisions upstart script</span>
</span><span class='line'><span class="n">template</span> <span class="s1">&#39;/etc/init/marinara.conf&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">source</span> <span class="s1">&#39;marinara.conf.erb&#39;</span>
</span><span class='line'>  <span class="n">mode</span> <span class="mo">0440</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><strong>Deploy application.</strong> If the application will be provisioned in
production mode (as opposed to development mode where Vagrant mounts the
project directory), the recipe provisions the application user, creates
the deployment and log directories, copies over a ssh deploy key, clones
the <em>marinara</em> git repository, install dependencies, and optimizes assets. A
number of default attributes drive the deployment &mdash; the most important
of which is the <em>reference</em> attribute defining the git tag or branch to
deploy.</li>
</ul>


<figure class='code'><figcaption><span>site-cookbooks/marinara/attributes/default.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># defines marinara application deployment configuration</span>
</span><span class='line'><span class="n">default</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">development</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'><span class="n">default</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="s1">&#39;marinara&#39;</span>
</span><span class='line'><span class="n">default</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">repository</span> <span class="o">=</span> <span class="s1">&#39;git@github.com:smdahlen/marinara.git&#39;</span>
</span><span class='line'><span class="n">default</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="s1">&#39;master&#39;</span>
</span><span class='line'><span class="n">default</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">deploy_path</span> <span class="o">=</span> <span class="s1">&#39;/opt/marinara&#39;</span>
</span><span class='line'><span class="n">default</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">log_path</span> <span class="o">=</span> <span class="s1">&#39;/var/log/marinara&#39;</span>
</span><span class='line'><span class="n">default</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="mi">6</span>
</span><span class='line'><span class="n">default</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="mi">8000</span>
</span><span class='line'><span class="n">default</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">servers</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="s1">&#39;app0&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;127.0.0.1&#39;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>site-cookbooks/marinara/recipes/application.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">development</span>
</span><span class='line'>  <span class="c1"># stops marinara service if running</span>
</span><span class='line'>  <span class="n">service</span> <span class="s1">&#39;marinara&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">action</span> <span class="ss">:stop</span>
</span><span class='line'>    <span class="n">provider</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Provider</span><span class="o">::</span><span class="ss">Service</span><span class="p">:</span><span class="ss">:Upstart</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># provisions system user to run application</span>
</span><span class='line'>  <span class="n">user</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">user</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">system</span> <span class="kp">true</span>
</span><span class='line'>    <span class="n">shell</span> <span class="s1">&#39;/bin/false&#39;</span>
</span><span class='line'>    <span class="n">home</span> <span class="s1">&#39;/home/marinara&#39;</span>
</span><span class='line'>    <span class="n">supports</span> <span class="n">manage_home</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># provisions deploy key and ssh wrapper</span>
</span><span class='line'>  <span class="n">cookbook_file</span> <span class="s1">&#39;/tmp/deploy_id_rsa&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">source</span> <span class="s1">&#39;deploy_id_rsa&#39;</span>
</span><span class='line'>    <span class="n">mode</span> <span class="mo">0400</span>
</span><span class='line'>    <span class="n">owner</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">user</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">cookbook_file</span> <span class="s1">&#39;/tmp/deploy_ssh_wrapper&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">source</span> <span class="s1">&#39;deploy_ssh_wrapper&#39;</span>
</span><span class='line'>    <span class="n">mode</span> <span class="mo">0500</span>
</span><span class='line'>    <span class="n">owner</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">user</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># provisions deploy directory with app user permissions</span>
</span><span class='line'>  <span class="n">directory</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">deploy_path</span>  <span class="k">do</span>
</span><span class='line'>    <span class="n">owner</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">user</span>
</span><span class='line'>    <span class="n">group</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">user</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># provisions log directory with app user permissions</span>
</span><span class='line'>  <span class="n">directory</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">log_path</span>  <span class="k">do</span>
</span><span class='line'>    <span class="n">owner</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">user</span>
</span><span class='line'>    <span class="n">group</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">user</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># provisions git repository</span>
</span><span class='line'>  <span class="n">git</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">deploy_path</span>  <span class="k">do</span>
</span><span class='line'>    <span class="n">repository</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">repository</span>
</span><span class='line'>    <span class="n">reference</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">reference</span>
</span><span class='line'>    <span class="n">user</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">user</span>
</span><span class='line'>    <span class="n">group</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">user</span>
</span><span class='line'>    <span class="n">ssh_wrapper</span> <span class="s1">&#39;/tmp/deploy_ssh_wrapper&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># provisions npm application dependencies</span>
</span><span class='line'>  <span class="n">execute</span> <span class="s1">&#39;npm install&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">cwd</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">deploy_path</span>
</span><span class='line'>    <span class="n">command</span> <span class="s1">&#39;/usr/local/bin/npm install&#39;</span>
</span><span class='line'>    <span class="n">user</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">user</span>
</span><span class='line'>    <span class="n">group</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">user</span>
</span><span class='line'>    <span class="n">env</span> <span class="s1">&#39;HOME&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">user</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># provisions bower application dependencies</span>
</span><span class='line'>  <span class="n">execute</span> <span class="s1">&#39;bower install&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">cwd</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">deploy_path</span>
</span><span class='line'>    <span class="n">command</span> <span class="s1">&#39;bower install&#39;</span>
</span><span class='line'>    <span class="n">user</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">user</span>
</span><span class='line'>    <span class="n">group</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">user</span>
</span><span class='line'>    <span class="n">env</span> <span class="s1">&#39;HOME&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">user</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># optimizes browser assets</span>
</span><span class='line'>  <span class="n">execute</span> <span class="s1">&#39;grunt optimize&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">cwd</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">deploy_path</span>
</span><span class='line'>    <span class="n">command</span> <span class="s1">&#39;grunt optimize&#39;</span>
</span><span class='line'>    <span class="n">user</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">user</span>
</span><span class='line'>    <span class="n">group</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">user</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># starts marinara service</span>
</span><span class='line'>  <span class="n">service</span> <span class="s1">&#39;marinara&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">action</span> <span class="ss">:start</span>
</span><span class='line'>    <span class="n">provider</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Provider</span><span class="o">::</span><span class="ss">Service</span><span class="p">:</span><span class="ss">:Upstart</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><strong>Provision application firewall rule.</strong>To complete the second exit criteria,
I defined a firewall rule in the application recipe to allow traffic on the
specified application port with the upstream HAProxy server as the source.</li>
</ul>


<figure class='code'><figcaption><span>site-cookbooks/marinara/recipes/application.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># provisions firewall rule to support incoming application traffic</span>
</span><span class='line'><span class="n">include_recipe</span> <span class="s1">&#39;simple_iptables&#39;</span>
</span><span class='line'><span class="n">server</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">server</span>
</span><span class='line'><span class="n">port</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">port</span>
</span><span class='line'><span class="n">simple_iptables_rule</span> <span class="s1">&#39;application&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">rule</span> <span class="s2">&quot;-p tcp -s </span><span class="si">#{</span><span class="n">server</span><span class="si">}</span><span class="s2"> --dport </span><span class="si">#{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="n">jump</span> <span class="s1">&#39;ACCEPT&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Implement Chef Proxy Recipe</h2>

<p>To scale the application servers horizontally with the growth of product
usage, I implemented a Chef recipe to install and configure HAProxy. This
recipe leveraged the <a href="https://github.com/opscode-cookbooks/haproxy">haproxy</a> cookbook for most of the heavy lifting.
However, I had to <em>reopen</em> the template resource defined in that cookbook
to use my configuration template instead. The code snippet below demonstrates
this. In addition to providing custom configuration that references
deployed application servers, I implemented a firewall rule to accept traffic
on port 80 (the default value for the incoming_port attribute). In a future
week, I intend to tune HAProxy&rsquo;s configuration based on performance testing.</p>

<figure class='code'><figcaption><span>site-cookbooks/marinara/attributes/default.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># includes default haproxy cookbook attributes first to override</span>
</span><span class='line'><span class="n">include_attribute</span> <span class="s1">&#39;haproxy&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># defines haproxy configuration</span>
</span><span class='line'><span class="n">default</span><span class="o">.</span><span class="n">haproxy</span><span class="o">.</span><span class="n">install_method</span> <span class="o">=</span> <span class="s1">&#39;source&#39;</span>
</span><span class='line'><span class="n">default</span><span class="o">.</span><span class="n">haproxy</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;1.5-dev17&#39;</span>
</span><span class='line'><span class="n">default</span><span class="o">.</span><span class="n">haproxy</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://haproxy.1wt.eu/download/1.5/src/devel/haproxy-1.5-dev17.tar.gz&#39;</span>
</span><span class='line'><span class="n">default</span><span class="o">.</span><span class="n">haproxy</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">checksum</span> <span class="o">=</span> <span class="s1">&#39;b8deab9989e6b9925410b0bc44dd4353&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">default</span><span class="o">.</span><span class="n">marinara</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>site-cookbooks/marinara/recipes/proxy.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># provisions haproxy</span>
</span><span class='line'><span class="n">include_recipe</span> <span class="s1">&#39;haproxy&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># overrides haproxy cookbook default configuration</span>
</span><span class='line'><span class="n">template</span> <span class="o">=</span> <span class="n">resources</span><span class="p">(</span><span class="s1">&#39;template[/etc/haproxy/haproxy.cfg]&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">template</span><span class="o">.</span><span class="n">source</span> <span class="s1">&#39;haproxy.cfg.erb&#39;</span>
</span><span class='line'><span class="n">template</span><span class="o">.</span><span class="n">cookbook</span> <span class="s1">&#39;marinara&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># provisions firewall rule to support incoming http traffic</span>
</span><span class='line'><span class="n">include_recipe</span> <span class="s1">&#39;simple_iptables&#39;</span>
</span><span class='line'><span class="n">simple_iptables_rule</span> <span class="s1">&#39;proxy&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">rule</span> <span class="s2">&quot;-p tcp --dport </span><span class="si">#{</span><span class="n">node</span><span class="o">.</span><span class="n">haproxy</span><span class="o">.</span><span class="n">incoming_port</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="n">jump</span> <span class="s1">&#39;ACCEPT&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>site-cookbooks/marinara/templates/default/haproxy.cfg.erb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">global</span>
</span><span class='line'>  <span class="n">log</span> <span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span> <span class="n">local0</span>
</span><span class='line'>  <span class="n">maxconn</span> <span class="mi">4096</span>
</span><span class='line'>  <span class="n">user</span> <span class="n">haproxy</span>
</span><span class='line'>  <span class="n">group</span> <span class="n">haproxy</span>
</span><span class='line'>
</span><span class='line'><span class="n">defaults</span>
</span><span class='line'>  <span class="n">log</span> <span class="n">global</span>
</span><span class='line'>  <span class="n">mode</span> <span class="n">http</span>
</span><span class='line'>  <span class="n">option</span> <span class="n">httplog</span>
</span><span class='line'>  <span class="n">option</span> <span class="n">dontlognull</span>
</span><span class='line'>  <span class="n">option</span> <span class="n">redispatch</span>
</span><span class='line'>  <span class="n">option</span> <span class="n">forwardfor</span>
</span><span class='line'>  <span class="n">timeout</span> <span class="n">connect</span> <span class="mi">5</span><span class="n">s</span>
</span><span class='line'>  <span class="n">timeout</span> <span class="n">client</span> <span class="mi">50</span><span class="n">s</span>
</span><span class='line'>  <span class="n">timeout</span> <span class="n">server</span> <span class="mi">50</span><span class="n">s</span>
</span><span class='line'>  <span class="n">balance</span> <span class="o">&lt;</span><span class="sx">%= node.haproxy.balance_algorithm %&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sx">frontend http</span>
</span><span class='line'><span class="sx">  bind 0.0.0.0:&lt;%=</span> <span class="n">node</span><span class="o">.</span><span class="n">haproxy</span><span class="o">.</span><span class="n">incoming_port</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">  default_backend application</span>
</span><span class='line'>
</span><span class='line'><span class="sx">backend application</span>
</span><span class='line'><span class="sx">  &lt;% node.marinara.application.servers.each_pair do |name, addr| -%&gt;</span>
</span><span class='line'>  <span class="n">server</span> <span class="o">&lt;</span><span class="sx">%= name %&gt; &lt;%=</span> <span class="n">addr</span> <span class="sx">%&gt;:&lt;%= node.marinara.application.port %&gt;</span> <span class="n">check</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="sx">% end </span><span class="o">-%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Test with Multi-Machine Vagrant Environment</h2>

<p>To finish off the week, I created a <em>Vagrantfile</em> in the <em>marinara-kitchen</em>
repository that creates three virtual machines using VirtualBox. Specifically,
I created a definition for the HAProxy server and a definition for the
Node.js application servers running on a private network so they could
communicate with one another. Here is the configuration below using the new
Vagrant 1.1 syntax:</p>

<figure class='code'><figcaption><span>Vagrantfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">app_servers</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="ss">app0</span><span class="p">:</span> <span class="s1">&#39;10.0.5.3&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">app1</span><span class="p">:</span> <span class="s1">&#39;10.0.5.4&#39;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s1">&#39;precise64-chef11.2&#39;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span> <span class="o">=</span> <span class="s1">&#39;https://opscode-vm.s3.amazonaws.com/vagrant/opscode_ubuntu-12.04_chef-11.2.0.box&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:virtualbox</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
</span><span class='line'>    <span class="n">vb</span><span class="o">.</span><span class="n">customize</span> <span class="o">[</span><span class="s1">&#39;setextradata&#39;</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s1">&#39;VBoxInternal2/SharedFoldersEnableSymlinksCreate/v-root&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">forward_agent</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:proxy</span> <span class="k">do</span> <span class="o">|</span><span class="n">proxy</span><span class="o">|</span>
</span><span class='line'>    <span class="n">proxy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s1">&#39;10.0.5.2&#39;</span>
</span><span class='line'>    <span class="n">proxy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:chef_solo</span> <span class="k">do</span> <span class="o">|</span><span class="n">chef</span><span class="o">|</span>
</span><span class='line'>      <span class="n">chef</span><span class="o">.</span><span class="n">cookbooks_path</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;cookbooks&#39;</span><span class="p">,</span> <span class="s1">&#39;site-cookbooks&#39;</span><span class="o">]</span>
</span><span class='line'>      <span class="n">chef</span><span class="o">.</span><span class="n">data_bags_path</span> <span class="o">=</span> <span class="s1">&#39;data_bags&#39;</span>
</span><span class='line'>      <span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span> <span class="s1">&#39;marinara::default&#39;</span>
</span><span class='line'>      <span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span> <span class="s1">&#39;marinara::security&#39;</span>
</span><span class='line'>      <span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span> <span class="s1">&#39;marinara::proxy&#39;</span>
</span><span class='line'>      <span class="n">chef</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="ss">marinara</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="ss">application</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="ss">servers</span><span class="p">:</span> <span class="n">app_servers</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">app_servers</span><span class="o">.</span><span class="n">each_pair</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="n">ip</span><span class="o">|</span>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:&quot;</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="ss">&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">app</span><span class="o">|</span>
</span><span class='line'>      <span class="n">app</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="n">ip</span>
</span><span class='line'>      <span class="n">app</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:chef_solo</span> <span class="k">do</span> <span class="o">|</span><span class="n">chef</span><span class="o">|</span>
</span><span class='line'>      <span class="n">chef</span><span class="o">.</span><span class="n">cookbooks_path</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;cookbooks&#39;</span><span class="p">,</span> <span class="s1">&#39;site-cookbooks&#39;</span><span class="o">]</span>
</span><span class='line'>      <span class="n">chef</span><span class="o">.</span><span class="n">data_bags_path</span> <span class="o">=</span> <span class="s1">&#39;data_bags&#39;</span>
</span><span class='line'>        <span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span> <span class="s1">&#39;marinara::default&#39;</span>
</span><span class='line'>        <span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span> <span class="s1">&#39;marinara::security&#39;</span>
</span><span class='line'>        <span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span> <span class="s1">&#39;marinara::application&#39;</span>
</span><span class='line'>        <span class="n">chef</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>          <span class="ss">marinara</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="ss">application</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>              <span class="ss">reference</span><span class="p">:</span> <span class="s1">&#39;develop&#39;</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>            <span class="ss">proxy</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>              <span class="ss">server</span><span class="p">:</span> <span class="s1">&#39;10.0.5.2&#39;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>  With the Vagrantfile implemented, I brought the servers up and
  executed a quick test with curl against my endpoints. With a successful
  response, the fourth criteria had been met and the week&rsquo;s task complete.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vagrant up
</span><span class='line'>$ curl http://10.0.5.2/
</span><span class='line'>$ curl http://10.0.5.2/api/hello</span></code></pre></td></tr></table></div></figure>



</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Shawn Dahlen</span></span>

      








  


<time datetime="2013-03-18T13:21:00-04:00" pubdate data-updated="true">Mar 18<span>th</span>, 2013</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://smdahlen.github.com/blog/2013/03/18/setup-node-dot-js-servers-within-a-load-balanced-configuration/" data-via="smdahlen" data-counturl="http://smdahlen.github.com/blog/2013/03/18/setup-node-dot-js-servers-within-a-load-balanced-configuration/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/03/06/automate-provisioning-of-secure-servers/" title="Previous Post: Automate provisioning of secure servers">&laquo; Automate provisioning of secure servers</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/04/12/manage-all-application-environments-with-vagrant/" title="Next Post: Manage all application environments with Vagrant">Manage all application environments with Vagrant &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section id="product">
	<a href="https://4dashes.com" target="_blank">
		<img src="/images/4dashes.png" alt="4dashes">
	</a>
	<p>
		Check out the results of my startup &mdash; a productivity tool
		that transforms your todo list into a game.
	</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/03/21/4dashes-the-web-client-part-2/">4dashes - the Web Client, Part 2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/03/19/4dashes-the-web-client-part-1/">4dashes - the Web Client, Part 1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/03/17/4dashes-the-api/">4dashes - the API</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/03/13/4dashes-the-build-system/">4dashes - the Build System</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/03/12/working-smarter-not-longer/">Working Smarter, Not Longer</a>
      </li>
    
  </ul>
</section>


<section>
	<h1 style="margin-bottom:10px">Latest Tweets</h1>
	<a class="twitter-timeline" href="https://twitter.com/smdahlen" data-widget-id="443486127396114432">Tweets by @smdahlen</a>
	<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Shawn Dahlen -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'shawndahlen';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://smdahlen.github.com/blog/2013/03/18/setup-node-dot-js-servers-within-a-load-balanced-configuration/';
        var disqus_url = 'http://smdahlen.github.com/blog/2013/03/18/setup-node-dot-js-servers-within-a-load-balanced-configuration/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
